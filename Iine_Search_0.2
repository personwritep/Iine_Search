// ==UserScript==
// @name        Iine Search
// @namespace        http://tampermonkey.net/
// @version        0.2
// @description        「いいね！された記事」の過去のアクション検索
// @author        Ameba Blog User
// @match        https://blog.ameba.jp/ucs/iine/list.html
// @icon        https://www.google.com/s2/favicons?sz=64&domain=ameba.jp
// @grant        none
// @updateURL        https://github.com/personwritep/Iine_Search/raw/main/Iine_Search.user.js
// @downloadURL        https://github.com/personwritep/Iine_Search/raw/main/Iine_Search.user.js
// ==/UserScript==


let slow_open;
let order=0;
let stop;
let search_id=0;




setTimeout(()=>{
    let iHEF=document.querySelector('#iineHistoryEntryFrame tbody');
    if(iHEF){
        order_environ();

        let monitor0=new MutationObserver(order_environ);
        monitor0.observe(iHEF, { childList: true });
    }
}, 1000);


function order_environ(){
    let cnt=document.querySelectorAll('.iineEntryCnt');
    for(let k=0; k<cnt.length; k++){
        cnt[k].onclick=function(event){
            order_is(k); }}

    function order_is(k){
        order=k; }

} // order_environ()




document.addEventListener('keydown', (event)=>{
    if(event.keyCode==119){ //「F8」押下
        event.preventDefault();
        get_id(); }
    if(event.keyCode==120){ //「F9」押下
        event.preventDefault();
        set_order(); }
    if(event.keyCode==27){ //「ESC」押下
        stop=1;
        un_dark(); }
});



function get_id(){
    let iLI=document.querySelectorAll('.iineListItem a');
    if(iLI.length==0){
        alert(
            '検索するユーザーを設定するには、\n'+
            '　➔ 目的のユーザーを含むダイアログを開きます \n'+
            '　➔「F8」を押してから 目的ユーザーをクリックします' ); }
    else{
        for(let i=0; i<iLI.length; i++){
            iLI[i].onclick=function(event){
                event.preventDefault();
                event.stopImmediatePropagation();
                get(iLI[i]); }}}

    function get(target){
        let link=target.getAttribute('href');
        if(link){
            let part=link.split('/');
            search_id=part[part.length-2];
            alert('検索するユーザーのID：　'+ search_id); }}

} // get_id()



function dark(){
    let iELM=document.querySelector('#iineEntryListMask');
    if(iELM){
        iELM.classList.remove('hide'); }}


function un_dark(){
    let iELM=document.querySelector('#iineEntryListMask');
    let iEF=document.querySelector('#iineEntryFrame');
    if(iELM && iEF){
        if(iEF.clientHeight==0){
            iELM.classList.add('hide'); }}}




function set_order(){
    if(search_id==0){
        alert('「F8」を押して検索するユーザーのIDを設定してください'); }
    else{
        let iLI=document.querySelectorAll('.iineListItem a');
        if(iLI.length==0){
            alert('検索開始のリスト行のダイアログを開いてください'); }
        else{
            open_all();
        }}

} // set_order()



function open_all(){
    let iCB=document.querySelector('#iineCloseBtn');
    let cnt=document.querySelectorAll('.iineEntryCnt');

    stop=0;
    iCB.click();
    dark();

    let slow_open=setInterval(work, 2000);

    function work(){
        if(stop==0){
            cnt[order].click(); }

        setTimeout(()=>{
            stop=search_who();
        }, 1200);

        setTimeout(()=>{
            if(stop==0){
                iCB.click();
                dark(); }
        }, 1600);

        if(order>cnt.length || stop==1){
            clearInterval(slow_open);
            order -=1; }

        order +=1;

    } // work()



    function search_who(){
        let get=0;
        let iLI=document.querySelectorAll('.iineListItem a');
        for(let i=0; i<iLI.length; i++){
            let link=iLI[i].getAttribute('href');
            if(link){
                if(link.includes(search_id)){
                    iLI[i].style.outline='2px solid red';
                    iLI[i].style.outlineOffset='6px';
                    iLI[i].scrollIntoView();
                    get=1; }}}

        return get;

    } // search_who()

} // open_all()


